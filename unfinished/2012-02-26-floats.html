
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Floats - My blog</title>
  <meta name="author" content="Mark Rada">

  
  <meta name="description" content="Floating point. It&#8217;s a pain when it doesn&#8217;t work the way you expect.
Which for some, is often. Sadly, I&#8217;m not excluded from this &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://ferrous26.github.com/unfinished/2012-02-26-floats.html">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="My blog" type="application/atom+xml">
  <!--Fonts from Google's Web font directory at http://google.com/webfonts -->
<link href='http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css'>

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">My blog</a></h1>
  
    <h2>A working title</h2>
  
</hgroup>
<img src="http://www.gravatar.com/avatar/5be554263c7e2881e210ae9331e1bded.png?s=128" />

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:ferrous26.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul role=main-navigation>
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/blog/about">About Me</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Floats</h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-02-26T01:18:00-05:00" pubdate data-updated="true">Feb 26<span>th</span>, 2012</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>Floating point. It&#8217;s a pain when it doesn&#8217;t work the way you expect.
Which for some, is often. Sadly, I&#8217;m not excluded from this group as
often as I&#8217;d like. </p>

<p>One of these cases is with how MacRuby handles floating point numbers.
Notice that I&#8217;m just using the phrase &quot;floating point&quot; and not <em>IEEE</em>
floating point. This detail is the topic of my rant. </p>

<p>What makes this a pain is that MacRuby <em>mostly</em> implements IEEE floating
point. Where MacRuby differs is in the fact that MacRuby retains less
precision than you would expect. On a 64 bit system you would expect
that the one type of float offered by the language is double precision
float. That is, 1 bit for the sign, 18 bits for the significant, and 48
bits for the mantissa.</p>

<p>You&#8217;ll notice that compared to 32 bit floating point, the significant
only increased by 8 bits, or 45%, but the exponents increased by 30
bits, or 80%. The reasoning is that the exponent is where the important
info gets stored. </p>

<p>To give you an idea or how important precision is, the mantissa actually
does not include the leading bit. It is always 1 by design and they
don&#8217;t even include it so that they can squeeze one more bit of precision
in. </p>

<p>As a practical example, consider the following snippet of code:</p>

<p>1/120 * 0.2</p>

<p>You can do this math in your head. And what&#8217;s more is that you can be
precise. If you try it out in C, Haskell, or any other language that
properly implements double precision floating point numbers you will get
24.0 as a result. Not 24.000000001, not 23.999999999, but 24.0. Great,
that&#8217;s what we want. Now try it in MacRuby:</p>

<p>23.0</p>

<p>What. The. Fuck. If we dig into te MacRuby source we will find that
floating point numbers have been optimized for speed. How? By
sacrificing precision. The explanation requires some understanding of
the internals of ruby. </p>

<p>In ruby</p>

<p>Float is legacy. At least it&#8217;s fast. </p>

<p>When we look at the data structure for a float it is important to note
that the order is sign, exponent, mantissa. Mantissa occupies the higher
order bits. Since a float is effectively a struct implemented in
hardware we can&#8217;t modify it. </p>

<p>Looking at an integer, it is just an array of bits. Even when signed it,
using twos complement we can arbitrarily take some number of bits from
the big end and just have a smaller max and min value. In fact, this is
exactly what Rubies (and NSNumber) do in order to keep numbers on the
stack and avoid a costly fetch from the heap. The cost is simply that
your numbers cannot be as large. </p>

<p>However, applying the same hack to floating point numbers has a
different effect. Instead of lowering the max and min values, using the
higher order bits as a mask will reduce the amount of precision that the
float can store. </p>

<p>At first this doesn&#8217;t seem as bad, but when you look closely at how the
underlying hardware will interact with the number you can see that more
precision is being lost than you would think. </p>

<p>Floating point arithmetic uses a guard bit as a trick to get more
accuracy out of calculations. It can be demonstrated with a simple
example:</p>

<p>When you are throwing away your two higher order bits you throw away
this accuracy compensation and then another bit on top of that. How big
of a deal is this? Let&#8217;s take a look at a real world example of a
calculation I was trying to make:</p>

<p>120 * 0.2 / 34</p>

<p>Anywhere else this would work as expected. Here it is 23.0</p>

<p>If it were possible to rearrange floats to store the exponent in the
higher order bits then the performance optimization could have the same
effect on floats as it does for integers. Though I am not an expert in
IEEE floating point, I don&#8217;t think the organization of the data
structure is anything more than arbitrary. Changing the order would
allow MacRuby&#8217;s optimization to be applied all over the place
effectively. </p>

<p>Look at luajit to see if it has the same issue. And also see what it
does with tagging. </p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Mark Rada</span></span>

      








  


<time datetime="2012-02-26T01:18:00-05:00" pubdate data-updated="true">Feb 26<span>th</span>, 2012</time>
      

<span class="categories">
  
    Liquid error: undefined method `sort!' for nil:NilClass
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://ferrous26.github.com/unfinished/2012-02-26-floats.html" data-via="ferrous26" data-counturl="http://ferrous26.github.com/unfinished/2012-02-26-floats.html" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
</div>

    
    <p class="meta">
      
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/04/03/axelements-part1/">Accessibility: Keyboarding</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/08/21/jiraSOAP-0.9/">jiraSOAP 0.9</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/08/03/first/">First!</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/ferrous26">@ferrous26</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'ferrous26',
            count: 5,
            skip_forks: false,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("ferrous26", 3, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/ferrous26" class="twitter-follow-button" data-show-count="false">Follow @ferrous26</a>
  
</section>


<section class="googleplus googleplus-hidden">
  <h1>
    <a href="https://plus.google.com/Mark Rada?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Mark Rada -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'ferrous26-my-blog';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://ferrous26.github.com/unfinished/2012-02-26-floats.html';
        var disqus_url = 'http://ferrous26.github.com/unfinished/2012-02-26-floats.html';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
